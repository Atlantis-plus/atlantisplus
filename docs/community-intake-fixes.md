# Community Intake Mode ‚Äî Fixes & Improvements

> –ó–∞–¥–∞—á–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏

### 1. Join state —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–µ–ø–ª–æ–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** `PENDING_JOIN_CONVERSATIONS` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ Python. –ü—Ä–∏ —Ä–µ–¥–µ–ø–ª–æ–µ state = {}.

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π state –≤ –ë–î.

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É (users –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é)
ALTER TABLE ... ADD COLUMN pending_join_community_id UUID;
ALTER TABLE ... ADD COLUMN pending_join_at TIMESTAMPTZ;
```

**–õ–æ–≥–∏–∫–∞:**
- `/start join_XXX` ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ–º community_id + timestamp
- –ü—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–æ–º ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ (—Å TTL 1 —á–∞—Å)
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ join ‚Üí SET NULL

**–§–∞–π–ª—ã:**
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è
- [ ] `community_handlers.py`: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î –≤–º–µ—Å—Ç–æ dict
- [ ] Cleanup expired –∑–∞–ø–∏—Å–µ–π (–º–æ–∂–Ω–æ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ–π –∏–ª–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ)

---

### 2. Person —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–µ–∑ telegram_id –∏ community_id
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–≥–¥–∞ join flow —Å–ª–æ–º–∞–ª—Å—è, –≥–æ–ª–æ—Å–æ–≤–æ–µ –ø–æ—à–ª–æ –≤ –æ–±—ã—á–Ω—ã–π pipeline ‚Üí —Å–æ–∑–¥–∞–ª—Å—è person –±–µ–∑ —Å–≤—è–∑–∏ —Å community.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–≥–¥–∞ fix #1 –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤. –ù–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `create_community_profile()`:
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `telegram_id` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ person
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `community_id` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ person
- [ ] Identity —Å `namespace=telegram_user_id` —Å–æ–∑–¥–∞—ë—Ç—Å—è

---

## UX —É–ª—É—á—à–µ–Ω–∏—è

### 3. Confirmation flow –ø–æ—Å–ª–µ extraction
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ä–∞–∑–æ–±—Ä–∞–ª–æ—Å—å, –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ø—Ä–∞–≤–∏—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ extraction –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.

**–î–ª—è join flow:**
```
‚úÖ –î–ª—è —Ç–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –≤ Serge FM —è —Ä–∞–∑–æ–±—Ä–∞–ª:

üë§ –ñ–∏—Ä–∏–∫
üíº –ü–æ–ª–∏—Ç–∏–∫
üéØ –ú–æ–∂–µ—à—å –ø–æ–º–æ—á—å: —é–º–æ—Ä, –ø–æ–ª–∏—Ç–∏–∫–∞
üîç –ò—â–µ—à—å: [–Ω–µ —É–∫–∞–∑–∞–Ω–æ]

[‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å] [‚úèÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç—å] [üóëÔ∏è –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ]
```

**–î–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫:**
```
üìù –ó–∞–ø–∏—Å–∞–ª –ø—Ä–æ –í–∞—Å—é –ü—É–ø–∫–∏–Ω–∞:
‚Ä¢ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Google
‚Ä¢ —Å–∏–ª—ë–Ω –≤ ML

[‚úÖ –û–∫] [‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å]
```

**–§–∞–π–ª—ã:**
- [ ] `community_handlers.py`: confirmation –ø–æ—Å–ª–µ self-intro extraction
- [ ] `handlers.py`: confirmation –ø–æ—Å–ª–µ –æ–±—ã—á–Ω–æ–≥–æ extraction (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ)

---

### 4. Follow-up –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ role/offer/seek –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞ –º–æ–ª—á–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ confirmation, –µ—Å–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å.

```
‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!

üí° –•–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å:
‚Ä¢ –ß–µ–º –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å –¥—Ä—É–≥–∏–º?
‚Ä¢ –ß—Ç–æ –∏—â–µ—à—å –≤ community?

[üé§ –î–æ–ø–æ–ª–Ω–∏—Ç—å –≥–æ–ª–æ—Å–æ–º] [‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å] [‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å]
```

**–§–∞–π–ª—ã:**
- [ ] `community_handlers.py`: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –ø–æ—Å–ª–µ save
- [ ] –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `awaiting_followup` –≤ join flow

---

### 5. LLM –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "–ø—Ä–æ —Å–µ–±—è" vs "–ø—Ä–æ –¥—Ä—É–≥–æ–≥–æ"
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–∂–µ —Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º state, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤ join mode –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –ø—Ä–æ –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.

**–†–µ—à–µ–Ω–∏–µ:** LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–≤–æ–µ/—Ç—Ä–µ—Ç—å–µ –ª–∏—Ü–æ.

```python
# –í extraction prompt –¥–æ–±–∞–≤–∏—Ç—å:
"is_first_person": true/false  # –≥–æ–≤–æ—Ä–∏—Ç –ª–∏ —á–µ–ª–æ–≤–µ–∫ –æ —Å–µ–±–µ
```

–ï—Å–ª–∏ `is_first_person=false` –≤ join mode ‚Üí —Å–ø—Ä–æ—Å–∏—Ç—å:
```
ü§î –ü–æ—Ö–æ–∂–µ —ç—Ç–æ –∑–∞–º–µ—Ç–∫–∞ –ø—Ä–æ –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∑–∞–º–µ—Ç–∫—É –∏–ª–∏ —ç—Ç–æ –≤—Å—ë-—Ç–∞–∫–∏ –æ —Ç–µ–±–µ?

[üìù –≠—Ç–æ –∑–∞–º–µ—Ç–∫–∞] [üë§ –≠—Ç–æ –ø—Ä–æ –º–µ–Ω—è]
```

**–§–∞–π–ª—ã:**
- [ ] `self_intro_prompt.py`: –¥–æ–±–∞–≤–∏—Ç—å `is_first_person` –≤ schema
- [ ] `community_handlers.py`: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è first_person=false

---

## UI/Mini App

### 6. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–ª–µ–Ω–æ–≤ community –¥–ª—è –∞–¥–º–∏–Ω–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞—Ç–µ–ª—å community –Ω–µ –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –≤—Å—Ç—É–ø–∏–≤—à–∏—Ö —á–ª–µ–Ω–æ–≤ –≤ Mini App.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å CommunitiesPage –∏ CommunityDetailPage.

**CommunitiesPage** (`/communities`):
- –°–ø–∏—Å–æ–∫ communities –∫–æ—Ç–æ—Ä—ã–º–∏ –≤–ª–∞–¥–µ—é
- –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å community"
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ: –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–ª-–≤–æ —á–ª–µ–Ω–æ–≤, invite link

**CommunityDetailPage** (`/communities/:id`):
- –ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ
- Invite link (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)
- –°–ø–∏—Å–æ–∫ —á–ª–µ–Ω–æ–≤ —Å –∏—Ö –ø—Ä–æ—Ñ–∏–ª—è–º–∏
- Regenerate invite link

**–§–∞–π–ª—ã:**
- [ ] `frontend/src/pages/CommunitiesPage.tsx`
- [ ] `frontend/src/pages/CommunityDetailPage.tsx`
- [ ] `frontend/src/App.tsx`: –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç—ã
- [ ] –ù–∞–≤–∏–≥–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–± –∏–ª–∏ –ø—É–Ω–∫—Ç –º–µ–Ω—é

---

### 7. Community member –≤–∏–¥–∏—Ç –ø–æ–ª–Ω—ã–π UI –≤–º–µ—Å—Ç–æ SelfProfilePage
**–ü—Ä–æ–±–ª–µ–º–∞:** –ñ–∏—Ä–∏–∫ –≤–∏–¥–∏—Ç –≤—Å–µ —Ç–∞–±—ã (People, Notes, Chat) –≤–º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.

**–ü—Ä–∏—á–∏–Ω–∞:** `get_user_type` –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑—å telegram_id ‚Üí person ‚Üí community (–ø–æ—Ç–æ–º—É —á—Ç–æ person —Å–æ–∑–¥–∞–ª—Å—è –±–µ–∑ —ç—Ç–∏—Ö –ø–æ–ª–µ–π).

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—Å—è –∫–æ–≥–¥–∞ fix #1 –∏ #2 –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã. –ù–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- [ ] `useUserType.ts`: –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç community_member
- [ ] `App.tsx`: –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç SelfProfilePage –¥–ª—è community_member
- [ ] Backend `/auth/me`: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π user_type

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Phase 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (—Å–Ω–∞—á–∞–ª–∞)
1. [x] –ú–∏–≥—Ä–∞—Ü–∏—è: –ø–æ–ª—è –¥–ª—è pending join (`pending_join` —Ç–∞–±–ª–∏—Ü–∞)
2. [x] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ join flow –Ω–∞ –ë–î (`get_pending_join`, `set_pending_join`, etc.)
3. [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å create_community_profile (telegram_id, community_id —É–∂–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è)

### Phase 2: Confirmation flow
4. [x] Confirmation –ø–æ—Å–ª–µ join extraction (—É–∂–µ –±—ã–ª–æ, –∫–Ω–æ–ø–∫–∏ Confirm/Edit)
5. [x] Follow-up –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç missing fields)

### Phase 3: Edge cases
6. [x] LLM first_person detection (`is_first_person` –≤ extraction)
7. [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ "–∑–∞–º–µ—Ç–∫–∞ –≤ join mode" (–∫–Ω–æ–ø–∫–∏ "It's about me" / "Save as note")

### Phase 4: Admin UI
8. [x] CommunitiesPage (frontend/src/pages/CommunitiesPage.tsx)
9. [x] CommunityDetailPage (frontend/src/pages/CommunityDetailPage.tsx)
   - NOTE: Frontend –∏–º–µ–µ—Ç pre-existing TS –æ—à–∏–±–∫–∏, –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∏–∫—Å

---

## –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–ø–æ—Å–ª–µ —Ñ–∏–∫—Å–æ–≤)

```
1. @evgenyq —Å–æ–∑–¥–∞—ë—Ç community "Test Community"
2. –ü–æ–ª—É—á–∞–µ—Ç invite link: t.me/atlantisplus_bot?start=join_XXX
3. @zhirik –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ
4. –ë–æ—Ç: "Welcome to Test Community! Tell us about yourself..."
5. –ñ–∏—Ä–∏–∫ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ –æ —Å–µ–±–µ
6. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç extraction + confirmation
7. –ñ–∏—Ä–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
8. –ë–æ—Ç: "Profile created! Want to add what you can help with?"
9. –ñ–∏—Ä–∏–∫ –¥–æ–ø–æ–ª–Ω—è–µ—Ç
10. @evgenyq –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App ‚Üí –≤–∏–¥–∏—Ç –ñ–∏—Ä–∏–∫–∞ –≤ —á–ª–µ–Ω–∞—Ö community
11. @zhirik –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App ‚Üí –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ SelfProfilePage
```
